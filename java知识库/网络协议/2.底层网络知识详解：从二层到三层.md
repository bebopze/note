### 2. 底层网络知识详解：从二层到三层


###### 2.1  从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？

```
    
    ⼩结：
    
        有三个重点需要你记住：
        
            第⼀，MAC 层是⽤来解决多路访问的堵⻋问题的；
            
            第⼆，ARP 是通过吼的⽅式来寻找⽬标 MAC 地址的，吼完之后记住⼀段时间，这个叫作缓存；
            
            第三，交换机是有 MAC 地址学习能⼒的，学完了它就知道谁在哪⼉了，不⽤⼴播了。
           
            
        
    QA：
        
        1. 如果⼀个局域⽹⾥⾯有多个交换机，ARP ⼴播的模式会出现什么问题呢？
                    
            ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。
            
            比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。
            
            如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。
            
            如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，行成广播风暴。

        
        2. Hub：
        
           1.一个广播域，一个冲突域。
           
           2.传输数据的过程中易产生冲突，带宽利用率不高
          
          
        3. Switch：
           
           1.在划分vlan的前提下可以实现多个广播域，每个接口都是一个单独的冲突域
           
           2.通过自我学习的方法可以构建出CAM表，并基于CAM进行转发数据。
           
           3.支持生成树算法。可以构建出物理有环，逻辑无环的网络，网络冗余和数据传输效率都甩Hub好几条街。SW是目前组网的基本设备之一。

```

###### 2.2  交换机与VLAN：办公室太复杂，我要回学校

```
    
    ⼩结：
    
        当交换机的数⽬越来越多的时候，会遭遇环路问题，让⽹络包迷路：
        
            这就需要使⽤	STP	协议，通过华⼭论剑⽐武的⽅式，将有环路的图变成没有环路的树，从⽽解决环路问题。
        
        交换机数⽬多会⾯临隔离问题：
            
            可以通过 VLAN 形成虚拟局域⽹，从⽽解决⼴播问题和安全问题。
         
        
        
    QA：
        
        1. stp中如果有掌门死掉了，又得全部重选一次，用的时间比较长，期间网络就会中断的
        
        
        2. 文中提到：
           
            当 机器2 要访问 机器1 的时候，机器2 并不知道 机器1 的 MAC 地址，所以 机器2 会发起一个 ARP 请求。
           
            这个广播消息会到达 机器1，也同时会到达 交换机A。
           
            这个时候 交换机A 已经知道 机器1 是不可能在右边的网口的，所以这个广播信息就不会广播到局域网二和局域网三。
            
            
            根据前一小节的内容，我有以下理解：
           
               1. 交换机是二层设备，不会读取 IP 层的内容。
               2. 交换机会缓存 MAC 地址跟转发端口的关系。
               3. ARP 协议是广播的，目的地 MAC 地址是广播地址。
           
            如果我的理解是正确的，那 机器2 发起的 ARP 请求中，是不含机器 1 的 MAC 地址的，只有广播地址。
           
            交换机A 中缓存的信息是没法被利用起来的。
           
            那么交换机 A 是如何知道不需要把请求转发到其它局域网的呢？
           
           
            回复: 
            
                好像这个说法的确有问题，不是arp过程的，是发包过程的，由全部转发变成有脑子的
           
           
        3. STP 对于跨地域甚至跨国组织的网络支持，就很难做了，计算量摆着呢。
           
        4. ping 加抓包工具，如 wireshark
        
        
```

###### 2.3  ICMP与ping：投石问路的侦察兵

```
    
    ⼩结：
    
        ICMP 相当于⽹络世界的侦察兵。
        
        
        这里讲了两种类型的 ICMP 报⽂：
        
            ⼀种是 主动探查的查询报⽂
            
            ⼀种是 异常报告的差错报⽂
        
        
        ping 使⽤查询报⽂，
        
        Traceroute 使⽤差错报⽂。
    
    
    
    QA：
        
        1. 你知道 ping 是如何⼯作的吗？
        
            ping 是基于 ICMP 协议⼯作的。
            
            ICMP全称Internet Control Message Protocol，就是互联⽹控制报⽂协议。
            
            这⾥⾯的关键词是“控制”，那具体是怎么控制的呢？
        
        
        2. 对于携带ICMP差错报文的数据报，不再产生ICMP差错报文。 
          
            如果主机A发送了一个ICMP的数据报文给主机B，数据在传输过程中经过其中一个路由器出现错误，
            
            由于该路由器已经接收到一个ICMP数据报文，所以不会再产生一个ICMP差错报文。
        
        
        3. 对于分片的数据报，如果不是第一个分片，则不产生ICMP差错报文 
            
            对于主机A发送了一个分片的数据，如果路由设备或主机接收到的分片数据不是第一个分片数据，不会产生ICMP差错报文。
        
        
        4. 对于具有多播地址的数据报，不产生ICMP差错报文 
         
            如果一个ip地址是一个广播地址的话，不会产生ICMP差错报文。
        
        
        5. 对于具有特殊地址如（127.0.0.0或0.0.0.0）的数据报，不产生ICMP差错报文
        
        
        
        
        6. 当发送的报⽂出问题的时候，会发送⼀个	ICMP 的差错报⽂来报告错误，但是如果	ICMP 的差错报⽂也出问题了呢？
            
            好像不发ICMP差错报文的一种情况就是ICMP 的差错报文出错，其它还有目的地址为广播时或者源地址不唯一时也不发差错报文。
           
            前面评论问udp为什么返回ICMP报文的，
            
            ICMP一般认为属于网络层的，和IP同一层，是管理和控制IP的一种协议，
           
            而UDP和TCP是传输层，所以UDP出错可以返回ICMP差错报文
        
           
        7. TTL的作用没有讲清楚，特此记录一下。
        
           TTL是网络包里的一个值，它告诉路由器包在网络中太长时间是否需要被丢弃。
           
           TTL最初的设想是，设置超时时间，超过此范围则被丢弃。
           
           每个路由器要将TTL减一，TTL通常表示被丢弃前经过的路由器的个数。
           
           当TTL变为0时，该路由器丢弃该包，并发送一个ICMP包给最初的发送者。 
           
           
           tranceroute差错报文会使用
        
        
        8. 许多人问：tracerouter发udp，为啥出错回icmp？
            
            正常情况下，协议栈能正常走到udp，当然正常返回udp。
            
            但是，你主机不可达，是ip层的（还没到udp）。
            
            ip层，当然只知道回icmp。
            
            报文分片错误也是同理。
            
            
        9. 以我的经验使用tcp/udp协议可以用scoket api编程，但是文中提到ping程序使用了ip协议，
        
            那ping程序的实现是不是用到了其他网络编程接口？
           
            换句话说，每一层的协议都有相应的api可以调用吗？
            
            有的话又是什么呢？但又感觉我们写的程序一般是应用层用socket就行了…
           
           
            回复: 
           
                不是每一层都有接口的，tcp ip协议栈在内核里面，内核的最外层是系统调用，所以你看起来就只能调用socket了    
        
        
        10. Traceroute发送的是udp包，为什么也能收到icmp响应呢？
        
            所以是侦查兵啊，错误了就会发
        
           
        11. ptraceroute用了udp包，为什么也能收到返回的icmp包呢？
        
            出错了就能了
            
        
        12. tracerouter发送的包是什么程序给的响应？ 是目标主机的traceroute程序？还是ICMP
        
            没有服务端，全部在制造错误
            
        13. 差错包也出问题是不是就拉到了，看上层是不是定时重发的协议了？
        
            是的，差错包不会在发差错包
            
            
               
```


###### 2.4  世界这么大，我想出网关：欧洲十国游与玄奘西行

```
    
    ⼩结：
    
        如果离开本地局域⽹，就需要经过⽹关，⽹关是路由器的⼀个⽹⼝；
            
        路由器是⼀个三层设备，⾥⾯有如何寻找下⼀跳的规则；
            
        经过路由器之后 MAC 头要变，如果 IP 不变，相当于不换护照的欧洲旅游，如果 IP 变，相当于换护照的⽞奘⻄⾏。
            
    
    
        1.玄奘西游，需要转换IP地址，把 外网与内网 相互转换，欧洲十日游 不需要转换 IP地址；
        
        2.静态配置路由 为规定 哪个口 访问对应的外网；
        
        3.离开 局域网 需要经过网关，网关是路由器的一个网口；
        
        4.路由为三层设备，里面包括 下一跳的信息；
        
       
    
    
    QA：
        
        1. NAT Gateway会以 源IP + 源端口 的方式记录连接的NAT记录，Ping是直接调用的ICMP，
            
            不经过第四层的协议，并没有端口号，
            
            请问，同一内网的两台机器同时Ping百度，再收到两个应答之后，在没有端口号做区分的情况下，如何进行转发？
            
            
            回复: 
                
                连接维护用哈希匹配，tcp有端口的一种算法，icmp也有相应的算法
            
        
        
        2. NAT 是有session的
        
        
        3. 当在你家⾥要访问 163 ⽹站的时候，你的包需要 NAT 成为 公⽹IP，返回的包⼜要 NAT 成你的 私有IP，
        
            返回包怎么知道这是你的请求呢？
            
            它怎么就这么智能的 NAT 成了你的	IP ⽽⾮别⼈的IP 呢？
            
            
            --
            
            老师在讲“玄奘西行游”的过程，只讲了服务器A给服务器B发包的情况，没有讲服务器B给服务器A回复包的情况，其实是类似的。
            
            根据私有ip（国家身份证）不能在公网上面出现的原则，我列一下回去的包的内容是怎样的：
            
                假设和服务器A直连的路由器为路由器a，和服务器B直连的路由器为路由器b。
            
                    服务器B->路由器b
                    源MAC：192.168.1.101的MAC
                    目标MAC：192.168.1.1的MAC
                    源IP：192.168.1.101
                    目标IP：192.168.56.1
                    
                    路由器b->路由器a
                    源MAC：192.168.56.2的MAC
                    目标MAC：192.168.56.1的MAC
                    源IP：192.168.56.2
                    目标IP：192.168.56.1
                    
                    路由器a->服务器A
                    源MAC：192.168.1.1的MAC
                    目标MAC：192.168.1.101的MAC
                    源IP：192.168.56.2
                    目标IP：192.168.1.101
            
            最关键的地方在于，当第二个包到达路由器a时，它是怎么知道服务器A的私有ip（国家身份证）的呢？路由器a有个引射表，
            
            可以通过公有ip（护照）查找出私有ip（国家身份证）。
            
            
            --
            
            公网IP转 私有IP，以及私有IP转化为公网IP，可以用一套算法，正向、反向类推。
        
        
        
        4. 如果是我主动发起请求，我怎么知道目标服务器在目标网关上的端口号是多少？
        
            网关不会改变监听端口，服务器的监听端口是 知名端口，比如80
            
            
        5. wan口地址怎么来的？是否在到达公网前的这一段链路上每一跳都需要NAT？
        
            wan口地址是运营商分配的，只有最后一跳使用nat
            
        
        6. 不同的网段依靠路由器进行， 2个不同的路由之间是直连网段吗？
         
            在讲解中，相邻的路由之间使用arp协议进行广播通信，那就是直接工作在mac层了， 
            
            但是路由器是三层设备， 工作在网络层， 这一点不是很清楚？
            
            
            -- 
            
            两个路由之间，之前有一个口是同一网段的
        
        
        
        7. 对于路由规则，这⼀节讲述了静态路由，需要⼿动配置，如果要⾃动配置，你觉得应该怎么办呢？
                   
            自动匹配 可以用 数据结构+算法，自动匹配路由的IP，既方便又效率。
            
            
            
```


###### 2.5  路由协议：西出网关无故人，敢问路在何方

```
    
    ⼩结：
    
        路由分 静态路由和动态路由：
        
            静态路由：
                
                可以配置复杂的策略路由，控制转发策略；
            
            
            动态路由 主流算法有两种：
                
                距离⽮量算法和链路状态算法。
                
                基于两种算法产⽣两种协议，BGP 协议 和 OSPF 协议。
    
        
    
    QA：
        
        1. BGP基于TCP，OSPF基于UDP
        
        2. 运营商1和eth2的连接是一对一的是什么意思？
        
            /32 的话，子网掩码是255.255.255.255，eth2和运营商并不在一个网络，是怎么通信的？
            
            
             回复: p2p
             
             
        3. 静态路由实现原理：
             - 3项路由：目标ip，出口ip，下一跳网关IP
             - 策略路由：多路由表/多路径
             
           动态路由实现原理：
             - 距离矢量路由算法：BGP
             - 链路状态路由算法：OSPF


        4. BGP用到的路径矢量路由协议是距离矢量路由协议的升级版？
        
            就是保存了路径
            
        
        5. rip是udp协议，ospf直接发ip包。而bgp使用tcp协议，路由器之间会建立tcp连接，每60s发送一次 keepalive 消息。
        
        
        6. 简单路由器是有多个网卡的，记得路由器网络设置里分为lan口和wlan口设置，
        
            这两口的mac地址不同，说明lan和wlan是两个网卡，
            
            但是路由器是有多个lan口的，发现lan口的mac地址是统一的，这是不是说明lan是一个网卡，且有多个网口;
            
            wlan是一个网卡?
            
            还有就是lan和wlan是两个网卡，他们之间的网络包传递是怎么实现的？
            
            
            
            回复: 
            
                是的，家用路由器虽然多个口，但是其实像我们示意图里面一样，是一个地址加交换机的形式。
                
                wlan和lan要过路由
                
        
        7. 路由器之间的协议交互全部用的为组播报文，组播报文走的为专门的组播路由协议。
        
        8. 路由器之间的协议交互采用的组播报文，根据RFC的规定，部分组播地址为专用的地址，用来传输路由信息。       
            
        
        9. 我有一个问题，我们发出去的包，半路上会不会经过某个公司的局域网，有会这种可能性吗?
        
            一般不会，可以看BGP协议，人家不会让你过的    
        
        
        
        10. 
            
            一、求最短距离的两个常见算法：
        
                1.1 Bellman-Ford：是求含负权图的单源最短路径的一种算法，效率较低，代码难度较小。
                
                    其原理为连续进行松弛，在每次松弛时把每条边都更新一下，若在n-1次松弛后还能更新，
                    
                    则说明图中有负环，因此无法得出结果，否则就完成。
                    
                1.2 Dijkstra：是从一个顶点到其余各顶点的最短路径算法，解决的是有向图中最短路径问题。
                    
                    迪杰斯特拉算法主要特点是以起始点为中心向外层层扩展，直到扩展到终点为止。
            
            
            二、路由器的路由算法：
            
                2.1 距离矢量路由算法：
                    每个路由器维护一张路由表，即一个矢量，它以网络中的每个路由器为索引，
                    
                    表中列出了当前已知的路由器到每个目标路由器的最佳距离，以及所使用的线路。
                    
                    通过在邻居之间相互交换信息，路由器不断地更新他们的内部路由表。（该算法基于Bellman-Ford）
                    
                2.2 链路状态路由算法：
                    
                    是要求网络中所有参与链路状态路由协议的路由器都掌握网络的全部拓扑结构信息，并记录在路由数据库中。
                    
                    链路状态算法中路由数据库实质上是一个网络结构的拓扑图，该拓扑图由一个节点的集合和一个边的集合构成。
                    
                    在网络拓扑图中，结点代表网络中路由器，边代表路由器之间的物理链路。
                    
                    在网络拓扑结构图中，每一条链路上可以附加不同的属性，例如链路的状态、距离或费用等。
                    
                    如果每一个路由器所保存的网络拓扑结构图都是一致的，那么个路由器生成的路由表也是最佳的，
                    
                    不存在错误路由或循环路由。（该算法基于Dijkstra）。
            
            
            三：基于两个路由算法而衍生出来的两个路由协议：
            
                3.1基于距离矢量路由算法的BGP协议：???
            
                3.2基于链路状态路由算法的OSPF协议：???
            
            
            小结：
            
                1.距离矢量路由算法存在环回路由，慢收敛，无穷计算，扩展性差等，存在的问题：
                
                    环回路由，慢收敛，无穷计算，扩展性差，仅适用于小网络场景。
                
                2.链路状态路由算法：链路状态算法具有更快的收敛速度,具有更好的功能扩展能力.
                
                    还提供了更好的在规模上的可升级性，缺点：
                    
                    每个路由器需要有较大的存储空间，用以存储所收到的每一个节点的链路状态分组；
                    
                    计算工作量大，每次都必须计算最短路径。
            
            ===============================================================
            自我查阅总结：路由协议应该比老师讲的要深的深得多。
             
             并且是基于和结合很多另外的一些知识点而形成的一整套路由方案的解决课题。
             
             要深入理解和学习的话，还要学习的太多， 老师这个讲的只是一个敲门砖。    
             
             
```

