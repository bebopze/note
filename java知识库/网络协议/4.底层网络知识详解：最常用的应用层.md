## 4. 底层网络知识详解：最常用的应用层


#### 4.1  HTTP协议：看个新闻原来这么麻烦

```
    
    ⼩结：
    
        HTTP 协议虽然很常⽤，也很复杂，重点记住 GET、POST、 PUT、DELETE 这⼏个⽅法，以及重要的⾸部字段；
        
        HTTP 2.0 通过头压缩、分帧、⼆进制编码、多路复⽤等技术提升性能；
        
        QUIC 协议通过基于 UDP ⾃定义的类似 TCP 的连接、重试、多路复⽤、流量控制技术，进⼀步提升性能。
    
        
    
    QA：
        
        1. http1.0的队首阻塞
           
           对于同一个tcp连接，所有的http1.0请求放入队列中，只有前一个请求的响应收到了，然后才能发送下一个请求。
           
           可见，http1.0的队首组塞发生在客户端。
        
          
        2. http1.1的队首阻塞
           
           对于同一个tcp连接，http1.1允许一次发送多个http1.1请求，
           
           也就是说，不必等前一个响应收到，就可以发送下一个请求，这样就解决了http1.0的客户端的队首阻塞。
           
           但是，http1.1规定，服务器端的响应的发送要根据请求被接收的顺序排队，也就是说，先接收到的请求的响应也要先发送。
           
           这样造成的问题是，如果最先收到的请求的处理时间长的话，响应生成也慢，就会阻塞已经生成了的响应的发送。也会造成队首阻塞。
           
           可见，http1.1的队首阻塞发生在服务器端。
        
            
        3. http2是怎样解决队首阻塞的
           
           http2无论在客户端还是在服务器端都不需要排队，在同一个tcp连接上，有多个stream，由各个stream发送和接收http请求，各个steam相互独立，互不阻塞。
           
           只要tcp没有人在用那么就可以发送已经生成的requst或者reponse的数据，在两端都不用等，从而彻底解决了http协议层面的队首阻塞问题。


        
        
        4. 每次http都要经过TCP的三次握手四次挥手吗
        
             keepalive就不用
             
             
        5. 以前一直不是很确定Keep-Alive的作用，今天结合tcp的知识，终于是彻底搞清楚了：
            
            其实就是浏览器访问服务端之后, 一个http请求的底层是tcp连接, tcp连接要经过三次握手之后,开始传输数据, 
            
            而且因为http设置了keep-alive,所以单次http请求完成之后这条tcp连接并不会断开, 而是可以让下一次http请求直接使用.
            
            当然keep-alive肯定也有timeout, 超时关闭.
            
        
        6. 如果要传输银行卡等敏感信息 使用TCP+SSL协议吗？
        
            当然
            
            
            

```


#### 4.2  HTTPS协议：点外卖的过程原来这么复杂

```
    
    ⼩结：
    
        加密分 对称加密 和 ⾮对称加密：
        
            对称加密   效率⾼，但是解决不了密钥传输问题；⾮对称加密可以解决这个问题，但是效率不⾼。
        
            ⾮对称加密 需要通过证书和权威机构来验证公钥的合法性。
        
        
        HTTPS 是 综合了 对称加密和⾮对称加密 算法的 HTTP 协议。既保证传输安全，也保证传输效率。
        
            
    
    QA：
        
        1. 各大CA机构的公钥是默认安装在操作系统里的。所以不要安装来路不明的操作系统，否则相当于裸奔
        
        
        2. https 非对称加密通信的过程：
           
            首先，服务端需要向证书颁发机构申请一个自己的证书，这个证书里面会包含此该站点的基本信息，个人啊，公司啊，组织什么呢，
            
            我记得CA证书好像分三类的，然后还有该证书的 签名 以及 hash 值用于在通信中客户端鉴别此证书是否合法。
            
            
            https 通信分为四个步骤：
           
                1. c->s,客户端发起加密通信请求，这个请求通常叫做 ClientHello请求，告知自己支持的协议版本号，加密算法，压缩算法，以及一个用于生成后续通信密钥的随机数；
                2. s->c,服务端响应，也叫作 ServerHello，确认加密通信协议，加密算法，以及一个用于生成后续通信密钥的随机数，还有网站证书；
                3. c->s,客户端在收到上一步服务端的响应之后，首先会检查证书的颁发者是否可信任，是否过期，域名是否一致，并且从操作系统的证书链中找出该证书的上一级证书，并拿出服务端证书的公钥，然后验证签名和hash，如果验证失败，就会显示警告，我们经常在Chrome里面看到，“此网站有风险，是否继续什么的”。如果验证通过，客户端会向服务端发送一个称作 “pre-master-key” 的随机数，该随机数使用证书的公钥加密，以及编码改变通知（以后咋们就用协商的密钥堆成加密通信了），客户端完成握手。
                4. 服务端在收到上一步客户端请求之后，也会确认我以后发给你的信息可就加密了哦，并且完成握手。
           
            此时，客户端有第一步自己生成的随机数，第二步收到服务端的随机数，第三步的 pre-master-key，
            
            服务端也是如此，他们就可以用这三个随机数使用约定的算法生成同一个密钥来加密以后的通信数据了。
        
        
        
```


#### 4.3  流媒体协议：如何在直播里看到美女帅哥？

```
    
    ⼩结：
    
        视频名词⽐较多，编码两⼤流派达成了⼀致，都是通过时间、空间的各种算法来压缩数据；
        
        压缩好的数据，为了传输组成⼀系列 NALU，按照帧和⽚依次排列；
        
        排列好的 NALU，在⽹络传输的时候，要按照	RTMP 包的格式进⾏包装，RTMP 的包会拆分成Chunk 进⾏传输；
        
        推送到流媒体集群的视频流经过转码和分发，可以被客户端通过 RTMP 协议拉取，然后组合为NALU，解码成视频格式进⾏播放。
        
        
        
        
    QA：
        
        1. 直播用TCP延迟太高了吧，，，他的保证有序，拥塞机制，，导致current等待之前的包
        
        
        2. rtmp的问题是基于tcp连接的，不适合做实时流传输
        
            改进方法，那就是把UDP引进
        
        
        

```


#### 4.4  P2P协议：我下小电影，99%急死你

```
    
    ⼩结：
    
        下载⼀个⽂件可以使⽤ HTTP 或 FTP，这两种都是集中下载的⽅式，
        
        ⽽ P2P 则换了⼀种思路，采取⾮中⼼化下载的⽅式；
        
        
        P2P 也是有两种：
        
            ⼀种是依赖于 tracker 的，也即元数据集中，⽂件数据分散；
        
            另⼀种是基于分布式的哈希算法，元数据和⽂件数据全部分散。
    
        
    
    QA：
        
        1. 试着解析为什么99.99%
        
            不论是依赖tracker，还是分布式哈希算法，p2p开宗明义就是要减轻server压力，把压力转嫁给client。
            
            99.99%的定义，是最后校验出了错误，漏失某个文件。
            
            而为什么会漏失呢？
            
                还是p2p开宗明义说的，把压力转嫁给client，当client流量压力过大而下线了，其他人就无法找到这个文件了，
            
                顶多DHT网络告诉每个client，漏失的文件在某个下线的人手上。
            
                你们就乖乖等他上线，并且把手上的99.99%分享给其他新来的new node吧。
            
            
            为了解决这个问题，最早应该是迅雷，提供了p2sp，长效种子，让server也有义务承担一些压力。
            
            至于迅雷为什么也会99.99%，应该是更进阶的技术问题了。比如下载网站专门防止迅雷盗链。你有张良计，我有过墙梯。
            
            

```


