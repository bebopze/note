1ã€åˆ†å¸ƒå¼ç›‘å¬ï¼ˆåˆ†å¸ƒå¼-è§‚å¯Ÿè€…æ¨¡å¼ï¼‰

    zk      znode åŠ¨æ€ç›‘å¬ï¼ˆK/Vï¼‰


2ã€åˆ†å¸ƒå¼é”

    Redis   SETNX KV

    zk      åˆ›å»ºznodeèŠ‚ç‚¹   suc / fail -> ç›‘å¬ znodeï¼ˆé‡Šæ”¾ -> é‡æ–°å°è¯•è·å–é”ï¼‰

    --------------------------------------------------------------------------------
    å¯¹æ¯”ï¼š

        zkä¼˜åŠ¿ï¼š

            redis   ==>   éœ€è¦è½®è¯¢å°è¯•è·å–é”   ->  è€—æ€§èƒ½
            zk      ==>   ç›‘å¬é€šçŸ¥           ->  æ— éœ€è½®è¯¢ï¼Œæ€§èƒ½å¼€é”€ä½


            redis   ==>   å®¢æˆ·ç«¯æŒ‚äº†  ->  ç­‰å¾…TTL            =>  ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”
            zk      ==>   å®¢æˆ·ç«¯æŒ‚äº†  ->  ä¸´æ—¶znodeè‡ªåŠ¨æ¶ˆå¤±   =>  è‡ªåŠ¨é‡Šæ”¾é”


            redisè‡´å‘½  ==>  é”ç»­æœŸ  ->  åå°å®šæ—¶çº¿ç¨‹ ç»­æœŸ


            redis  è½®è¯¢è·å–é”ã€è®¡ç®—TTL  ->   éº»çƒ¦
            zk     è¯­ä¹‰æ›´æ¸…æ™°


        redisä¼˜åŠ¿ï¼š

            redis   ==>   å¤©ç„¶æ”¯æŒ é«˜å¹¶å‘ï¼ˆé¢‘ç¹åŠ é”/é‡Šæ”¾é”ï¼‰

            zk      ==>   å¹¶å‘æ€§èƒ½ ä¸€èˆ¬  ï¼ˆzkçš„å¼ºä¸€è‡´æ€§ï¼‰


        ç»¼åˆï¼š
            zkçš„åˆ†å¸ƒå¼é” æ¯” Redisçš„åˆ†å¸ƒå¼é”    ==>   ç‰¢é ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ã€æ¨¡å‹å¥å£®ã€ç®€å•æ˜“ç”¨



3ã€åˆ†å¸ƒå¼äº‹åŠ¡


    1ã€XA(ä¸¤é˜¶æ®µæäº¤)            // å¼ºä¸€è‡´æ€§ï¼ˆå¼ºä¾èµ–DBï¼‰

        æ•°æ®åº“ åŸç”Ÿè·¨åº“äº‹åŠ¡ è§£å†³æ–¹æ¡ˆ

        ä½æ€§èƒ½      ->  ä¾èµ–DB XAåè®®  ->  éœ€è¦ç›´è¿DB

        åœºæ™¯ï¼š
            1ä¸ªåº”ç”¨  ->  ç›´è¿ Nä¸ªDB   ğŸš«ğŸš«ğŸš«   // å¾®æœåŠ¡ä¸¥ç¦ è·¨åº“ç›´è¿   ->   åªèƒ½é€šè¿‡APIè®¿é—® å…¶ä»–æœåŠ¡åº“çš„æ•°æ®



    2ã€TCC                      // å¼ºä¸€è‡´æ€§ï¼ˆæ‰‹åŠ¨ç¼–ç¨‹  ->  ä¸¥é‡ä¾èµ– æ‰‹åŠ¨å›æ»š/è¡¥å¿ï¼‰

        é¢„æ‰£èµ„æº   ->  ç¼–ç å¤æ‚ã€éš¾ç»´æŠ¤

        é€‚ç”¨åœºæ™¯ï¼š
            é‡‘è  +  çŸ­äº‹åŠ¡ï¼ˆæ‰§è¡Œå¿«ã€æ—¶é—´çŸ­ï¼‰


        å®ç°ï¼š

            æ¯ä¸€ä¸ªæœåŠ¡  ->  éƒ½éœ€è¦æä¾›3ä¸ªAPI

                try         ->    é¢„æ‰£/å†»ç»“  èµ„æº
                confirm     ->    æ‰§è¡Œ
                cancel      ->    æ‰‹åŠ¨ç»´æŠ¤ å›æ»šé€»è¾‘ï¼ˆæ¶å¿ƒ + éš¾ç»´æŠ¤ï¼‰  /  è¡¥å¿é€»è¾‘ï¼ˆå›æ»šå¤±è´¥ï¼‰        // æ‰§è¡ŒæˆåŠŸçš„  ->  å›æ»š



    3ã€Saga                     //  æœ€ç»ˆä¸€è‡´æ€§ï¼ˆè¡¥å¿äº‹åŠ¡ï¼‰  +  é«˜å¹¶å‘


        é•¿äº‹åŠ¡ã€é•¿æµç¨‹


        åŸç†ï¼š
            1ã€ä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…  ->   éƒ½æäº¤æœ¬åœ°äº‹åŠ¡
            2ã€è‹¥æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥    ->   åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…

            --------------------------------------------------------
            1ã€å·¦ä¾§æ˜¯æ­£å¸¸çš„äº‹åŠ¡æµç¨‹

            2ã€å½“æ‰§è¡Œåˆ° T3 æ—¶å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™å¼€å§‹æ‰§è¡Œå³è¾¹çš„äº‹åŠ¡è¡¥å¿æµç¨‹

                åå‘æ‰§è¡Œ T3ã€T2ã€T1 çš„è¡¥å¿æœåŠ¡ C3ã€C2ã€C1ï¼Œå°† T3ã€T2ã€T1 å·²ç»ä¿®æ”¹çš„æ•°æ®è¡¥å¿æ‰

            ----------------------------------------------------------------------------------------------------
            T1  ->  T2  ->  T3ï¼ˆerrï¼‰     ==>     C3  ->  C2  ->  C1      // ä¸»äº‹åŠ¡  ->  åŒæ­¥  / ä¹Ÿå¯å¼‚æ­¥ï¼ˆç»´æŠ¤ä»£ä»·ï¼‰


        åœºæ™¯ï¼š
            1ã€é—ç•™è€ç³»ç»Ÿã€ä¸‰æ–¹æœåŠ¡   ->   æ— æ³•æä¾› TCCæ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£
            2ã€ä¸šåŠ¡æµç¨‹é•¿ã€ä¸šåŠ¡æµç¨‹å¤š


        ä¼˜åŠ¿ï¼š
            1ã€ä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½

            2ã€å‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œé«˜åå

            3ã€è¡¥å¿æœåŠ¡æ˜“äºå®ç°ï¼Œå› ä¸ºä¸€ä¸ªæ›´æ–°æ“ä½œçš„åå‘æ“ä½œæ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„

        ç¼ºç‚¹ï¼š
            ä¸ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§




    4ã€æœ¬åœ°æ¶ˆæ¯è¡¨                ->  æœ€ç»ˆä¸€è‡´æ€§

        åŸç†ï¼š

            A
                1ã€å†™DB +  æ¶ˆæ¯è¡¨Aï¼ˆprepareï¼‰
                2ã€å‘é€æ¶ˆæ¯

                åå°çº¿ç¨‹   ->   æ‰«ç æ¶ˆæ¯è¡¨Aï¼ˆprepareï¼‰  ->  é‡æ–°å‘é€åˆ°MQ

            B
                1ã€æ”¶åˆ°æ¶ˆæ¯  ->  å†™æ¶ˆæ¯è¡¨Bï¼ˆé˜²æ­¢é‡å¤æ¶ˆè´¹ + prepareï¼‰  +  æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
                2ã€Bæ‰§è¡ŒæˆåŠŸ  ->  æ›´æ–° æ¶ˆæ¯è¡¨Bï¼ˆcommitï¼‰  +  æ¶ˆæ¯è¡¨Aï¼ˆcommitï¼‰

                äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ / æ›´æ–°æ¶ˆæ¯è¡¨Aå¤±è´¥çš„   ->  æ”¶åˆ°é‡å¤æ¶ˆæ¯   ->  check   ->   é‡æ–°æ‰§è¡Œäº‹åŠ¡B / æ›´æ–°æ¶ˆæ¯è¡¨A


        ä¸é€‚ç”¨ï¼š
            ä¸¥é‡ä¾èµ– DBçš„æ¶ˆæ¯è¡¨æ¥ç®¡ç†äº‹åŠ¡

            é«˜å¹¶å‘ä¸é€‚ç”¨

            æ‰©å±•æ€§å·®



    5ã€å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§         ->  æœ€ç»ˆä¸€è‡´æ€§


        ä¸¤é˜¶æ®µäº‹åŠ¡æ¶ˆæ¯ï¼ˆprepared/confirmï¼‰ + è½®è¯¢/å›è°ƒ          ->  RocketMQï¼ˆå·²å®ç°ï¼‰   /  å…¶ä»–MQ + è‡ªæ‰©å±•å®ç°


        å®ç°ï¼š

            Aç³»ç»Ÿï¼š
                1ã€å‘é€  å¸¦çŠ¶æ€æ¶ˆæ¯ï¼ˆpreparedï¼‰  ->   MQ      // æ¶ˆæ¯å‘é€å¤±è´¥  ->  ç›´æ¥fail

                2ã€Aæ‰§è¡Œæœ¬åœ°äº‹åŠ¡

                    æˆåŠŸ  ->   å‘é€ confirmæ¶ˆæ¯

                    å¤±è´¥  ->   å‘é€ cancelæ¶ˆæ¯


            MQï¼š
                å®šæ—¶è½®è¯¢   ->   prepared æ¶ˆæ¯   ->   å›è°ƒæ¥å£   ->   è¯¢é—®A  äº‹åŠ¡æ‰§è¡Œ æˆåŠŸ/å¤±è´¥


            Bç³»ç»Ÿï¼š
                1ã€æ”¶åˆ°  confirmæ¶ˆæ¯   ->   æ‰§è¡Œæœ¬åœ°äº‹åŠ¡

                2ã€Bæ‰§è¡Œæœ¬åœ°äº‹åŠ¡

                    æˆåŠŸ  ->   ok

                    å¤±è´¥  ->   æ— é™é‡è¯•  /      å›æ»š -> é€šçŸ¥Aç³»ç»Ÿ å›æ»š    /     è­¦æŠ¥ ->  äººå·¥å›æ»š/è¡¥å¿


        -----------------------------------------------------------
        RocketMQ äº‹åŠ¡æ¶ˆæ¯

            1ã€äº‹åŠ¡æ¶ˆæ¯ å¸¦çŠ¶æ€   ->   prepared / confirm / cancel

            2ã€è½®è¯¢  +  å›è°ƒæ¥å£



    6ã€æœ€å¤§åŠªåŠ›é€šçŸ¥              ->  æœ€ç»ˆä¸€è‡´æ€§        MQ + DB/é˜Ÿåˆ—

        åŸç†ï¼š
            1ã€Aç³»ç»Ÿ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ ok   ->   å‘é€æ¶ˆæ¯ åˆ°MQ

            2ã€ä¸“é—¨æ¶ˆè´¹MQçš„ æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡

                1ã€æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯   ->   è®°å½• DB/å†…å­˜é˜Ÿåˆ—

                2ã€è°ƒç”¨Bç³»ç»Ÿ

            3ã€Bç³»ç»Ÿ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡

                æˆåŠŸ   ->   ok

                å¤±è´¥   =>   æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡  ->  å®šæ—¶å°è¯• é‡æ–°è°ƒç”¨B   ->   åå¤Næ¬¡ï¼ˆå¯é…ï¼‰   =>  è¿˜æ˜¯ä¸è¡Œ  ->  æ”¾å¼ƒ


        åœºæ™¯ï¼š
            æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸­  å¯¹ä¸€è‡´æ€§è¦æ±‚æœ€ä½çš„ä¸€ç§

            é€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§æ—¶é—´æ•æ„Ÿåº¦ä½çš„ä¸šåŠ¡         ->      å……å€¼æˆåŠŸ - é€šçŸ¥






4ã€åˆ†å¸ƒå¼session

    redis

    JWT token


5ã€å¹‚ç­‰

    redis           set kv

    zk              create znode


6ã€é™æµ

    ç®—æ³•ï¼š
        1ã€è®¡æ•°å™¨           ç¬æ—¶å³°å€¼é—®é¢˜

        2ã€æ»‘åŠ¨çª—å£         å¯¹è®¡æ•°å™¨æ–¹å¼çš„æ”¹è¿›, å¢åŠ ä¸€ä¸ª æ—¶é—´ç²’åº¦ çš„åº¦é‡å•ä½      ==>   1min  ->  6ç­‰åˆ†

        3ã€æ¼æ¡¶             è§„å®šå›ºå®šå®¹é‡çš„æ¡¶

                                æœ‰æ°´è¿›å…¥ï¼Œæœ‰æ°´æµå‡º

                                å¯¹äºæµè¿›çš„æ°´æˆ‘ä»¬æ— æ³•ä¼°è®¡è¿›æ¥çš„æ•°é‡ã€é€Ÿåº¦ï¼Œ å¯¹äºæµå‡ºçš„æ°´  ->  æˆ‘ä»¬å¯ä»¥æ§åˆ¶é€Ÿåº¦

        4ã€ä»¤ç‰Œæ¡¶           è§„å®šå›ºå®šå®¹é‡çš„æ¡¶

                                token ä»¥å›ºå®šé€Ÿåº¦å¾€æ¡¶å†…å¡«å……ï¼Œå½“æ¡¶æ»¡æ—¶ -> token ä¸ä¼šè¢«ç»§ç»­æ”¾å…¥

                                æ¯è¿‡æ¥ä¸€ä¸ªè¯·æ±‚ ->  æŠŠtoken ä»æ¡¶ä¸­ç§»é™¤ï¼Œ  å¦‚æœæ¡¶ä¸­æ²¡æœ‰token -> ä¸èƒ½è¯·æ±‚


    å®ç°ï¼š
        Guavaã€spring cloud gatewayã€sentinel

